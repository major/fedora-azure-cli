name: Build containers

on:
  push:
    branches: [main]
    paths-ignore:
      - "README.md"
  pull_request:
    branches: [main]
    paths-ignore:
      - "README.md"
  workflow_dispatch:

env:
  PYTEST_ARGS: "-n 4 --disable-warnings --durations 10"

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: ${{ matrix.container }}
    strategy:
      fail-fast: false
      matrix:
        container:
          - quay.io/centos/centos:stream9
          - registry.fedoraproject.org/fedora:35
          - registry.fedoraproject.org/fedora:36
          - registry.fedoraproject.org/fedora:rawhide
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Install requirements
        run: |
          echo "fastestmirror=1" >> /etc/dnf/dnf.conf
          echo "max_parallel_downloads=20" >> /etc/dnf/dnf.conf
          dnf -y upgrade
          dnf -y install git python3 python3-pip
          pip3 install -U wheel pip pytest pytest-xdist virtualenv wget

      - name: Clone azure-cli
        uses: actions/checkout@v3
        with:
          repository: azure/azure-cli
          ref: azure-cli-2.37.0
          path: azure-cli

      - name: Install requirements
        run: |
          pip3 install -r azure-cli/src/azure-cli/requirements.py3.Linux.txt \
            azure-cli/src/azure-cli*/

      - name: Test azure-cli-core
        if: always()
        run: pytest $PYTEST_ARGS azure-cli/src/azure-cli-core

      - name: Test azure-cli-telemetry
        if: always()
        run: pytest $PYTEST_ARGS azure-cli/src/azure-cli-telemetry

      - name: Test azure-cli command modules
        if: always()
        run: |
          pushd src/azure-cli/azure/cli/command_modules/
            TEST_DIRECTORIES=$(find . -name latest -type d -printf " %p")
            pytest $PYTEST_ARGS $TEST_DIRECTORIES
          popd
